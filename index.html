<script>
const months=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

let current=new Date();
current.setDate(1);
let selected=null;
let monthPicker=false;

const today=new Date();
today.setHours(0,0,0,0);

const cal=document.getElementById("calendar");
const panel=document.getElementById("panel");
const title=document.getElementById("title");

title.onclick=toggleMonthPicker;

function key(y,m,d){return `${y}-${m}-${d}`;}

function toggleMonthPicker(){
  monthPicker=!monthPicker;
  panel.classList.remove("show");
  render();
}

function changeMonth(v){
  current.setMonth(current.getMonth()+v);
  selected=null;
  panel.classList.remove("show");
  render();
}

function render(){
  cal.innerHTML="";
  title.textContent=`${months[current.getMonth()]} ${current.getFullYear()}`;

  if(monthPicker){
    renderMonthPicker();
    return;
  }

  const y=current.getFullYear();
  const m=current.getMonth();
  const days=new Date(y,m+1,0).getDate();

  for(let d=1;d<=days;d++){
    const div=document.createElement("div");
    div.className="day";
    div.textContent=d;

    const date=new Date(y,m,d);
    date.setHours(0,0,0,0);

    if(date<today) div.classList.add("past");
    if(date.getTime()===today.getTime()) div.classList.add("today");

    const data=localStorage.getItem(key(y,m,d));
    if(data){
      const o=JSON.parse(data);
      div.classList.add(o.color);
      div.textContent=d;
    }

    div.onclick=()=>openDay(d);
    cal.appendChild(div);
  }
}

function renderMonthPicker(){
  cal.style.gridTemplateColumns="repeat(3,1fr)";
  months.forEach((name,i)=>{
    const div=document.createElement("div");
    div.className="day";
    div.textContent=name;
    div.style.height="50px";
    div.onclick=()=>{
      current.setMonth(i);
      monthPicker=false;
      render();
    };
    cal.appendChild(div);
  });
}

function openDay(d){
  selected=d;
  panel.classList.add("show");

  document.getElementById("panelDate").textContent=
    `${d} de ${months[current.getMonth()]}`;

  const k=key(current.getFullYear(),current.getMonth(),d);
  const data=localStorage.getItem(k);

  if(data){
    const o=JSON.parse(data);
    note.value=o.text;
    color.value=o.color;
    repeat.value=o.repeat;
  }else{
    note.value="";
    color.value="pink";
    repeat.value="none";
  }
}

function save(){
  if(!selected) return;

  const obj={
    text:note.value,
    color:color.value,
    repeat:repeat.value
  };

  const y=current.getFullYear();
  const m=current.getMonth();

  localStorage.setItem(key(y,m,selected),JSON.stringify(obj));

  if(obj.repeat==="month"){
    for(let i=0;i<12;i++){
      localStorage.setItem(key(y,i,selected),JSON.stringify(obj));
    }
  }

  if(obj.repeat==="year"){
    for(let i=y;i<y+20;i++){
      localStorage.setItem(key(i,m,selected),JSON.stringify(obj));
    }
  }

  render();
}

function removeNote(){
  if(!selected) return;

  const y=current.getFullYear();
  const m=current.getMonth();
  const k=key(y,m,selected);
  const data=localStorage.getItem(k);
  if(!data) return;

  const o=JSON.parse(data);

  if(o.repeat==="month"){
    for(let i=0;i<12;i++){
      localStorage.removeItem(key(y,i,selected));
    }
  }
  else if(o.repeat==="year"){
    for(let i=y;i<y+20;i++){
      localStorage.removeItem(key(i,m,selected));
    }
  }
  else{
    localStorage.removeItem(k);
  }

  selected=null;
  panel.classList.remove("show");
  render();
}

render();
</script>
